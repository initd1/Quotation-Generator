<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Quotation Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for print and general aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .quotation-table input, .quotation-table textarea {
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #d1d5db; /* border-gray-300 */
            width: 100%;
            transition: border-color 0.15s ease-in-out;
        }
        .quotation-table input:focus, .quotation-table textarea:focus {
            outline: none;
            border-color: #3b82f6; /* ring-blue-500 */
        }
        /* Custom number input styling to hide arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
            text-align: right;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: white;
            }
            .container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                border: none;
            }
            .quotation-table th, .quotation-table td {
                padding: 8px 4px !important;
                border: 1px solid #000;
            }
            .quotation-table th {
                background-color: #e5e7eb !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            /* Ensure text inputs and textareas show their content for printing */
            .quotation-table input[type="text"], 
            .quotation-table input[type="number"], 
            .quotation-table textarea {
                border: none !important;
                background: none !important;
                box-shadow: none !important;
                padding: 0;
            }
            /* Hide border for dynamically calculated text */
            .calculated-text {
                border: none;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl container">

        <!-- Action Buttons (No Print) -->
        <div class="flex flex-wrap gap-3 justify-end mb-6 no-print">
            <button id="saveButton" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out">
                Save Draft
            </button>
            <button id="clearButton" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 ease-in-out">
                Clear All
            </button>
            <button id="printButton" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out">
                Print Quotation
            </button>
        </div>

        <!-- Header Section -->
        <header class="flex flex-col md:flex-row justify-between items-start mb-8 border-b pb-4">
            <div class="mb-4 md:mb-0">
                <h1 class="text-3xl font-bold text-gray-800">QUOTATION</h1>
                <div class="text-sm text-gray-500 mt-1">
                    Quotation No: 
                    <input type="text" id="quotationNo" value="Q/2024/001" class="font-mono p-1 border rounded-md w-32" style="display: inline-block;">
                </div>
                <div class="text-sm text-gray-500 mt-1">
                    Date: 
                    <input type="date" id="quotationDate" class="font-mono p-1 border rounded-md" style="display: inline-block;">
                </div>
            </div>

            <div class="text-right">
                <h2 class="text-xl font-bold text-blue-700">SRI SRINIVASA AGENCIES</h2>
                <p class="text-sm text-gray-600">123 Main Street, Bangalore, India</p>
                <p class="text-sm text-gray-600">GSTIN: 29AABBCC1234Z5</p>
                <p class="text-sm text-gray-600">Email: contact@sriagencies.com | Phone: +91 98765 43210</p>
            </div>
        </header>

        <!-- Client Details -->
        <section class="mb-8 p-4 border rounded-lg bg-gray-50">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Customer Details (TO)</h3>
            <textarea id="clientDetails" rows="4" placeholder="Client Name, Address, Contact, and GSTIN..." class="w-full p-2 border rounded-md"></textarea>
        </section>
        
        <!-- Item Details Table -->
        <table class="w-full border-collapse quotation-table mb-8 text-sm">
            <thead>
                <tr class="bg-gray-200 text-gray-700 font-semibold uppercase tracking-wider">
                    <th class="border p-2 w-10">S.No</th>
                    <th class="border p-2 text-left w-64">Description of Item</th>
                    <th class="border p-2 w-16">Qty</th>
                    <th class="border p-2 w-20">Rate (₹)</th>
                    <th class="border p-2 w-16">GST %</th>
                    <th class="border p-2 w-24">Amount (₹)</th>
                    <th class="border p-2 w-24 no-print">Actions</th>
                </tr>
            </thead>
            <tbody id="quotationTableBody">
                <!-- Rows will be added here by JavaScript -->
            </tbody>
        </table>

        <button id="addRowButton" class="px-3 py-1 bg-indigo-500 text-white font-semibold rounded-full shadow-md hover:bg-indigo-600 transition duration-150 ease-in-out mb-8 no-print" aria-label="Add a new item row">
            + Add Line Item
        </button>

        <!-- Totals and Summary -->
        <section class="flex justify-end">
            <div class="w-full md:w-1/2">
                <div class="text-sm text-gray-700 space-y-2 p-4 border rounded-lg bg-gray-50">
                    <div class="flex justify-between">
                        <span class="font-medium">Total Amount (Before Tax):</span>
                        <span id="sumAmount" class="font-semibold">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">CGST Total:</span>
                        <span id="sumCGST" class="font-semibold">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">SGST Total:</span>
                        <span id="sumSGST" class="font-semibold">0.00</span>
                    </div>
                    <div class="flex justify-between border-t pt-2">
                        <span class="font-medium">Sub Total (Incl. Tax):</span>
                        <span id="sumGrandTotal" class="font-semibold">0.00</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium">Rounding Adjustment:</span>
                        <span id="sumRoundUp" class="font-semibold text-red-500">0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-green-700 pt-2">
                        <span>Grand Total (Payable):</span>
                        <span id="sumFinalTotal">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer / Terms -->
        <footer class="mt-12 pt-6 border-t">
            <h4 class="text-md font-semibold mb-2 text-gray-700">Terms & Conditions:</h4>
            <textarea id="terms" rows="3" class="w-full text-xs p-2 border rounded-md" placeholder="1. Payment is due within 30 days. 2. Price is valid for 15 days from the quotation date.">1. Payment is due within 30 days. 2. Price is valid for 15 days from the quotation date.</textarea>
            
            <div class="flex justify-end mt-8">
                <div class="text-center">
                    <div class="w-32 h-12 border-b border-gray-400 mb-2"></div>
                    <p class="text-sm font-semibold text-gray-700">Authorized Signature</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Constants and Globals
        const QUOTATION_KEY = 'modernQuotationData';
        let serialNoCounter = 1;

        // --- Utility Functions for Data Persistence ---

        function saveData() {
            const quotationData = {
                quotationNo: document.getElementById('quotationNo').value,
                quotationDate: document.getElementById('quotationDate').value,
                clientDetails: document.getElementById('clientDetails').value,
                terms: document.getElementById('terms').value,
                items: []
            };

            const rows = document.querySelectorAll('#quotationTableBody tr');
            rows.forEach(row => {
                quotationData.items.push({
                    description: row.querySelector('.itemDescription').value,
                    qty: row.querySelector('.itemQty').value,
                    rate: row.querySelector('.itemRate').value,
                    gstRate: row.querySelector('.gstRate').value,
                });
            });

            localStorage.setItem(QUOTATION_KEY, JSON.stringify(quotationData));
            showFeedback("Draft saved automatically.", "green");
        }

        function loadData() {
            const savedData = localStorage.getItem(QUOTATION_KEY);
            if (!savedData) {
                // Set default date and initial row if no data exists
                document.getElementById('quotationDate').valueAsDate = new Date();
                addRow(); 
                return;
            }

            try {
                const data = JSON.parse(savedData);
                document.getElementById('quotationNo').value = data.quotationNo || "Q/2024/001";
                document.getElementById('quotationDate').value = data.quotationDate || new Date().toISOString().substring(0, 10);
                document.getElementById('clientDetails').value = data.clientDetails || '';
                document.getElementById('terms').value = data.terms || '';

                // Clear existing rows and load saved items
                const tbody = document.getElementById('quotationTableBody');
                tbody.innerHTML = '';
                serialNoCounter = 1;
                
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        // Pass saved values to addRow to rebuild the table
                        addRow(item.description, item.qty, item.rate, item.gstRate);
                    });
                } else {
                    addRow(); // Add one empty row if items array is empty
                }
                
                calculateTotals();
                showFeedback("Draft loaded successfully.", "blue");
            } catch (error) {
                console.error("Error loading data from localStorage:", error);
                addRow(); // Add default row on error
                document.getElementById('quotationDate').valueAsDate = new Date();
            }
        }
        
        function clearAllData() {
            if (confirm("Are you sure you want to clear the entire quotation and saved draft?")) {
                localStorage.removeItem(QUOTATION_KEY);
                window.location.reload(); // Simple way to reset the UI
            }
        }
        
        // --- Core Application Logic ---

        function createRow(description = '', qty = 1, rate = 1, gstRate = 18) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            // Generate a unique ID for the row (useful for removal)
            const rowId = `row-${Date.now()}-${serialNoCounter}`;
            row.id = rowId;

            row.innerHTML = `
                <td class="border p-2 text-center text-gray-600 font-semibold">${serialNoCounter++}</td>
                <td class="border p-2">
                    <textarea class="itemDescription text-sm" rows="1" placeholder="Item Name / Service details">${description}</textarea>
                </td>
                <td class="border p-2">
                    <input type="number" class="itemQty text-right" value="${parseFloat(qty) || 1}" min="0.01">
                </td>
                <td class="border p-2">
                    <input type="number" class="itemRate text-right" value="${parseFloat(rate) || 1.00}" min="0.00">
                </td>
                <td class="border p-2">
                    <input type="number" class="gstRate text-right" value="${parseFloat(gstRate) || 18}" min="0" max="100">
                </td>
                <td class="border p-2 text-right font-medium text-gray-800">
                    <span class="itemAmount">0.00</span><br>
                    <span class="text-xs text-green-600">CGST: <span class="itemCGST">0.00</span></span><br>
                    <span class="text-xs text-green-600">SGST: <span class="itemSGST">0.00</span></span><br>
                    <span class="text-xs font-bold mt-1 block">Total: <span class="itemTotal">0.00</span></span>
                </td>
                <td class="border p-2 text-center no-print">
                    <button class="removeRowBtn text-red-500 hover:text-red-700 transition duration-150" data-row-id="${rowId}" aria-label="Remove this item row">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;

            return row;
        }

        function addRow(description, qty, rate, gstRate) {
            const tbody = document.getElementById('quotationTableBody');
            tbody.appendChild(createRow(description, qty, rate, gstRate));
            calculateTotals();
        }

        function removeRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                // Before removing, we need to reset the serial number sequence
                const tbody = document.getElementById('quotationTableBody');
                tbody.removeChild(row);
                
                // Recalculate totals and reset S.No column
                reindexRows();
                calculateTotals();
                saveData(); // Save state after removing
            }
        }
        
        function reindexRows() {
            const rows = document.querySelectorAll('#quotationTableBody tr');
            serialNoCounter = 1;
            rows.forEach(row => {
                row.firstElementChild.textContent = serialNoCounter++;
            });
        }

        function calculateTotals() {
            const rows = document.querySelectorAll('#quotationTableBody tr');
            let amountTotal = 0, cgstTotal = 0, sgstTotal = 0, grandTotal = 0;
            
            for (let row of rows) {
                // Use || 0 to safely handle empty or invalid inputs
                let qty = parseFloat(row.querySelector('.itemQty').value) || 0;
                let rate = parseFloat(row.querySelector('.itemRate').value) || 0;
                let gstRate = parseFloat(row.querySelector('.gstRate').value) || 0;
                
                // --- Calculations ---
                let amount = qty * rate;
                
                // GST calculations are based on the base amount
                let gstMultiplier = gstRate / 100;
                let cgst = (gstMultiplier / 2) * amount;
                let sgst = (gstMultiplier / 2) * amount;
                
                let total = amount + cgst + sgst;
                
                // --- Update Row Display ---
                row.querySelector('.itemAmount').textContent = amount.toFixed(2);
                row.querySelector('.itemCGST').textContent = cgst.toFixed(2);
                row.querySelector('.itemSGST').textContent = sgst.toFixed(2);
                row.querySelector('.itemTotal').textContent = total.toFixed(2);
                
                // --- Accumulate Totals ---
                amountTotal += amount;
                cgstTotal += cgst;
                sgstTotal += sgst;
                grandTotal += total;
            }
            
            // --- Final Totals with Rounding ---
            let roundUp = Math.ceil(grandTotal) - grandTotal;
            // Handle cases where grandTotal is already an integer (roundUp will be 0)
            if (Math.abs(roundUp) < 0.005) { // Check if rounding is negligible
                roundUp = 0;
            } else {
                // Only round up if it's positive, otherwise round down for negative
                roundUp = (grandTotal > 0 ? Math.ceil(grandTotal) : Math.floor(grandTotal)) - grandTotal;
            }

            let finalTotal = grandTotal + roundUp;
            
            // --- Update Summary Display ---
            document.getElementById('sumAmount').textContent = amountTotal.toFixed(2);
            document.getElementById('sumCGST').textContent = cgstTotal.toFixed(2);
            document.getElementById('sumSGST').textContent = sgstTotal.toFixed(2);
            document.getElementById('sumGrandTotal').textContent = grandTotal.toFixed(2);
            
            document.getElementById('sumRoundUp').textContent = roundUp.toFixed(2);
            // Display final total without decimals as it is rounded to the nearest integer
            document.getElementById('sumFinalTotal').textContent = Math.round(finalTotal);

            // Save data automatically on calculation
            saveData();
        }

        function printDocument() {
            window.print();
        }
        
        function showFeedback(message, type) {
            // Simple visual feedback mechanism (could be improved with a proper toast component)
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // --- Event Binding (Modern JS) ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Load data first
            loadData();

            // 2. Bind actions for dynamic item table (using event delegation for efficiency)
            document.getElementById('quotationTableBody').addEventListener('click', (event) => {
                const removeButton = event.target.closest('.removeRowBtn');
                if (removeButton) {
                    const rowId = removeButton.dataset.rowId;
                    removeRow(rowId);
                }
            });

            // Input event delegation for recalculation and autosave
            document.getElementById('app').addEventListener('input', (event) => {
                const target = event.target;
                
                // Check if the input is one of the calculation-relevant fields
                if (target.closest('#quotationTableBody') || 
                    target.id === 'quotationNo' ||
                    target.id === 'quotationDate' ||
                    target.id === 'clientDetails' ||
                    target.id === 'terms') 
                {
                    calculateTotals(); // Triggers saveData() inside
                }
            });

            // 3. Bind major buttons
            document.getElementById('addRowButton').addEventListener('click', () => addRow());
            document.getElementById('printButton').addEventListener('click', printDocument);
            document.getElementById('clearButton').addEventListener('click', clearAllData);
            
            // Explicit Save button (also triggers calculateTotals which saves data)
            document.getElementById('saveButton').addEventListener('click', () => {
                calculateTotals(); 
                showFeedback("Quotation manually saved!", "green");
            });
            
            // Re-index rows after initial load (if necessary, though addRow does it)
            reindexRows();
        });

    </script>
</body>
</html>